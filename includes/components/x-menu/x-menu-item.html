<!--
Menu for Website

style properties are --x-menu-style: desktop-full, desktop-lite, mobile, each for each platform
-->

<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="../../paper-styles/color.html">
<link rel="import" href="../../paper-styles/shadow.html">

<!--
*copied for reference to rewrite later*
Material design: [Progress & activity](https://www.google.com/design/spec/components/progress-activity.html)

The progress bars are for situations where the percentage completed can be
determined. They give users a quick sense of how much longer an operation
will take.

Example:

    <paper-progress value="10"></paper-progress>

There is also a secondary progress which is useful for displaying intermediate
progress, such as the buffer level during a streaming playback progress bar.

Example:

    <paper-progress value="10" secondary-progress="30"></paper-progress>

### Styling progress bar:

To change the active progress bar color:

    paper-progress {
       --paper-progress-active-color: #e91e63;
    }

To change the secondary progress bar color:

    paper-progress {
      --paper-progress-secondary-color: #f8bbd0;
    }

To change the progress bar background color:

    paper-progress {
      --paper-progress-container-color: #64ffda;
    }

Add the class `transiting` to a paper-progress to animate the progress bar when
the value changed. You can also customize the transition:

    paper-progress {
      --paper-progress-transition-duration: 0.08s;
      --paper-progress-transition-timing-function: ease;
      --paper-progress-transition-transition-delay: 0s;
    }

To change the duration of the indeterminate cycle:

    paper-progress {
      --paper-progress-indeterminate-cycle-duration: 2s;
    }

The following mixins are available for styling:

Custom property                                  | Description                                 | Default
-------------------------------------------------|---------------------------------------------|--------------
`--paper-progress-container-color`               | Mixin applied to container                  | `--google-grey-300`
`--paper-progress-transition-duration`           | Duration of the transition                  | `0.008s`
`--paper-progress-transition-timing-function`    | The timing function for the transition      | `ease`
`--paper-progress-transition-delay`              | delay for the transition                    | `0s`
`--paper-progress-active-color`                  | The color of the active bar                 | `--google-green-500`
`--paper-progress-secondary-color`               | The color of the secondary bar              | `--google-green-100`
`--paper-progress-disabled-active-color`         | The color of the active bar if disabled     | `--google-grey-500`
`--paper-progress-disabled-secondary-color`      | The color of the secondary bar if disabled  | `--google-grey-300`
`--paper-progress-height`                        | The height of the progress bar              | `4px`
`--paper-progress-indeterminate-cycle-duration`  | Duration of an indeterminate cycle          | `2s`

@group Paper Elements
@element paper-progress
@hero hero.svg
@demo demo/index.html
-->

<dom-module id="x-menu-item">
  <template>
    <style>
      /* Global styles */
      :host {
        font-weight: 500;
        cursor: pointer;
        letter-spacing: -0.01em;
        /* Prevent Text Selection */
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none;   /* Chrome/Safari/Opera */
        -khtml-user-select: none;    /* Konqueror */
        -moz-user-select: none;      /* Firefox */
        -ms-user-select: none;       /* Internet Explorer/Edge */
        user-select: none;
      }
      
      /* Desktop Styles */
      /* Tablet Styles */
      /* Mobile Styles */
      /* Normal Menu Item Styles */
      
      
      /* Sub Menu Item Styles */
      
      /* Active Styles */
      
      /* Disabled Styles */
      
      :host[is-mobile] {
        color: purple;
      }
      
      :host[sub-item] {
        font-weight: 400;
      }
      
      .x-menu-item-wrapper {
        transition: .125s background-color;
        width: 10em;
        height: 2.5em;
        text-align: center;
        line-height: 2.5em;
        font-size: 1.125em;
        border-bottom: .175em solid transparent;
        box-sizing: border-box;
        color: rgba(0,0,0,.54);
      }
      
      :host:hover > div > .x-menu-item-wrapper {
        /*background-color: var(--google-grey-100);*/
        border-bottom: .175em solid var(--google-grey-300);
        color: rgba(0,0,0,.87);
        background-color: var(--google-grey-100);
      }
      
      :host a {
        text-decoration: none;
        color: inherit;
      }
      
      :host:hover > a > .x-menu-item-wrapper {
        /*background-color: var(--google-grey-100);*/
        border-bottom: .175em solid var(--google-grey-300);
        color: rgba(0,0,0,.87);
        background-color: var(--google-grey-100);
      }
      
      .x-sub-menu-container {
        position: absolute;
        display: none;
        width: inherit;
        background-color: white;
        @apply(--shadow-elevation-3dp);
      }
      
      :host[open] > .x-menu-item-dropdown > .x-sub-menu-container {
        display: block;
      }
      
      :host[active] {
        cursor: default;
      }
      
      :host[disabled] {
        cursor: default;
      }
      
      :host[disabled] .x-menu-item-wrapper {
        color: rgba(0,0,0,.38);
      }
      
      :host[active] .x-menu-item-wrapper {
        color: rgba(0,0,0,.87);
        border-bottom: .175em solid var(--google-grey-300);
        background-color: var(--google-grey-100);
      }
      
      :host[open] > div >.x-menu-item-wrapper {
        color: rgba(0,0,0,.87);
        background-color: var(--google-grey-100);
      }
      
      :host[has-children] > div > .x-menu-item-wrapper {
        border-bottom: none;
      }
      
      :host[has-children]:hover .x-menu-item-wrapper {
        border-bottom: none;
      }
      
      :host[sub-item] .x-menu-item-wrapper {
        font-size: 1em;
        text-align: left;
        height: auto;
        width: 11.25em;
        line-height: 1.5em;
        border-bottom: none;
        padding: .5em;
        padding-left: .8em;
        padding-right: 1em;
      }
      
      :host[sub-item]:hover > a > .x-menu-item-wrapper {
        border-bottom: none;
        background-color: var(--google-grey-100);
      }
      
      :host[has-children] > .x-menu-item-dropdown > .x-menu-item-wrapper > iron-icon[expand-icon] {
        display: block;
        margin: 0 auto;
        height: 1.111em;
        width: 1.111em;
        margin-top: -.889em;
        transition: .3s transform cubic-bezier(0.215, 0.61, 0.355, 1);
      }
      
      :host[has-children][open] > .x-menu-item-dropdown > .x-menu-item-wrapper > iron-icon[expand-icon] {
        transform: rotate(180deg);
        margin-top: -.889em;
      }
      
      :host[has-children][sub-item] > .x-menu-item-dropdown > .x-menu-item-wrapper > iron-icon[expand-icon] {
        display: block;
        margin: 0;
        height: 1.445em;
        width: 1.125em;
        float: right;
        margin-right: -.55em;
        transition: .3s transform cubic-bezier(0.215, 0.61, 0.355, 1);
      }
      
      :host[has-children][sub-item][open] > .x-menu-item-dropdown > .x-menu-item-wrapper > iron-icon[expand-icon] {
        margin-top: auto;
      }
      
      :host[open][sub-item] > .x-menu-item-dropdown > .x-sub-menu-container {
        margin-top: -2.2em;
        margin-left: 11.25em;
      }
      
    </style>
    
    
    <template is="dom-if" if="{{_hasChildren}}">
        <div class="x-menu-item-dropdown">
            <div class="x-menu-item-wrapper">
                <content></content>
            </div>
            <div class="x-sub-menu-container"></div>
        </div>
    </template>
    
    <template is="dom-if" if="{{!_hasChildren}}">
        <template is="dom-if" if="{{disabled}}">
            <div class="x-menu-item-wrapper">
                <content></content>
            </div>
        </template>
        <template is="dom-if" if="{{!disabled}}">
            <a href="{{href}}">
                <div class="x-menu-item-wrapper">
                    <content></content>
                </div>
            </a>
        </template>
    </template>
    
  </template>
</dom-module>

<script>
Polymer({
    is: 'x-menu-item',
    properties: {
        //link
        href: String,
        
        //flags
        active: {
            type: Boolean,
            observer: '_activeFlagChanged'
        },
        disabled: {
            type: Boolean,
            value: false,
            observer: '_disabledFlagChanged'
        },
        subItem: {
            type: Boolean,
            observer: '_subItemFlagChanged'
        },
        open: {
            type: Boolean,
        },
        
        //flags for device type
        isMobile: {
            type: Boolean,
            observer: '_isMobileChanged'
        },
        isTablet: {
            type: Boolean,
            observer: '_isTabletChanged'
        },
        
        //private vars
        _hasChildren: {
            type: Boolean,
        },
        _menuItems: {
            value: function() {
                return this.queryAllEffectiveChildren('x-menu-item');
            }
        },
        _expandArrow: {
            value: function() {
                return document.createElement('iron-icon');
            }
        }
    },

    ready: function() {
        var childCount = Polymer.dom(this).children.length;
        this._hasChildren = false;
        if (childCount > 0) {
            this._hasChildren = true;
            //debug
            console.log("x-menu-item: hasChildren " + this._hasChildren);
            console.log("x-menu-item: " + childCount + " children found");
            // create iron-icon
            if (this.subItem) this._expandArrow.setAttribute('icon', "chevron-right");
            else this._expandArrow.setAttribute('icon', "expand-more");            
            this._expandArrow.setAttribute('expand-icon', "");
            this._expandArrow.setAttribute('class', 'x-menu-item');
            //insert iron-icon
            var subMenuItem = this.queryEffectiveChildren('x-menu-item');
            Polymer.dom(this).insertBefore(this._expandArrow, subMenuItem);
            this.setAttribute('has-children', "");
        }
        
        this._isMobileChanged();
        this._isTabletChanged();
    },
    
    attached: function() {
        if (!this._hasChildren) return;
        //move submenu container to end
        //Polymer.dom(this).appendChild(subMenuContainer);
        //console.log(subMenuContainer);
        //force sub-item flag on each sub item and move to container
        var subMenuContainer = this.$$('.x-sub-menu-container');
        for(var i=0; i < this._menuItems.length; i++){
            this._menuItems[i].setAttribute('sub-item', "");
            Polymer.dom(subMenuContainer).appendChild(this._menuItems[i]);
        }
        this.listen(document, 'tap', '_tapped');
    },
    
    detached: function() {
        if (!this._hasChildren) return;
        this.unlisten(document, 'tap', '_tapped');
    },
    
    _isMobileChanged: function() {
        if (!this._hasChildren) return;
        
        for(var i=0; i < this._menuItems.length; i++){
            if (this.isMobile)
                this._menuItems[i].setAttribute('is-mobile', "");
            else
                this._menuItems[i].removeAttribute('is-mobile');
        }
    },
    
    _isTabletChanged: function() {
        if (!this._hasChildren) return;
        
        for(var i=0; i < this._menuItems.length; i++){
            if (this.isTablet)
                this._menuItems[i].setAttribute('is-tablet', "");
            else
                this._menuItems[i].removeAttribute('is-tablet');
        }
    },
    
    _tapped: function(e) {
        if (!this._hasChildren && !this.open) return;
        
        var target = e.target;
        while(target != this && target != window.document) {
            //if the target reaches the sub menu node, ignore it.
            if (target == this.$$('.x-sub-menu-container')) return;
            //"bubble" the tapped target up until it either matches the current node or the document node.
            target = target.parentNode;
        }
        if(target == this) {
            // In current node
            //toggle open attribute
            if (!this.open)
                this.setAttribute('open', "");
            else
                this.removeAttribute('open');
            console.log("toggled");
        } else {
            // not
            this.removeAttribute('open');
            //console.log("closed");
        }
        
    },
    
    _subItemFlagChanged: function() {
        if (this.subItem) this._expandArrow.setAttribute('icon', "chevron-right");
        else this._expandArrow.setAttribute('icon', "expand-more");
    }
});
</script>
